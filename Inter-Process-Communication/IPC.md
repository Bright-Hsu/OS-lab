# IPC

## 实验目的

1. 编程实现进程的创建和软中断通信，通过观察、分析实验现象，深入理解进程及进程在调度执行和内存空间等方面的特点，掌握在POSIX 规范中系统调用的功能和使用。

2. 编程实现进程的管道通信，通过观察、分析实验现象，深入理解进程管道通信的特点，掌握管道通信的同步和互斥机制。

## 实验内容

### 进程的软中断通信

使用系统调用fork()创建两个子进程，再用系统调用signal()让父进程捕捉键盘上发出的中断信号（即按delete键），当父进程接收到这两个软中断的某一个后，父进程用系统调用kill()向两个子进程分别发出整数值为16和17软中断信号，子进程获得对应软中断信号，然后分别输出下列信息后终止：

Child process 1 is killed by parent !! 

Child process 2 is killed by parent !! 

父进程调用wait()函数等待两个子进程终止后，输入以下信息，结束进程执行：

Parent process is killed!! 

多运行几次编写的程序，简略分析出现不同结果的原因。

### 进程的管道通信

先猜想该管道程序的运行结果。分析管道通信是怎样实现同步与互斥的，然后按照注释里的要求把代码补充完整，运行程序。修改程序并运行，体会互斥锁的作用，比较有锁和无锁程序的运行结果，并解释之。

## 实验原理

### 软中断通信

**1、lockf(fd, function, size)用于进程互斥**

**2、int kill(pid, sig)传递中断信号**

（1）pid>0时，核心将信号发送给进程pid。

（2）pid=0时，核心将信号发送给与发送进程同组的所有进程。

（3）pid=-1时，核心将信号发送给所有用户标识符真正等于发送进程的有效用户标识号的进程。

**3、signal(sig,function)**

如果接收到中断信号就作相应处理

其中sig用于指定信号的类型，sig为0则表示没有收到任何信号。function：在该进程中的一个函数地址

  （1）function=1时，进程对sig类信号不予理睬，亦即屏蔽了该类信号；

  （2）function=0时，缺省值，进程在收到sig信号后应终止自己；

  （3）function为非0，非1类整数时，function的值即作为信号处理程序的指针。

**4、wait()和waitpid()**

wait（）会暂时停止进程的执行，直到有信号来到或子进程结束。

waitpid和wait的作用本质上相同，但waitpid多出了两个参数pid和options，

pid：pid>0时，只等待进程ID等于pid的子进程，不管子进程。pid=-1时，等待任何一个子进程退出，没有任何限制，此时waitpid作用同wait。pid=0时，等待同一个进程组中的任何子进程，如果子进程已经加入了别的进程组，waitpid不会对它做任何理睬。pid<-1时，等待一个指定进程组中的任何子进程，这个进程组的ID等于pid的绝对值。

options提供了一些额外的选项来控制waitpid，目前在Linux中只支持WNOHANG和WUNTRACED两个选项，这是两个常数，可以用"|"运算符把它们连接起来使用，比如：ret=waitpid(-1,NULL,WNOHANG | WUNTRACED)。如果我们不想使用它们，也可以把options设为0。

**5、sleep()和pause()**

sleep(n)进程暂停n秒，ctrl+c即SIGINT信号可以使sleep提前结束，继续运行。

pause()会令目前的进程暂停(进入睡眠状态), 直到被信号(signal)所中断.。

**6、alarm()**

alarm()用来设置信号SIGALRM 在经过参数seconds 指定的秒数后传送给目前的进程. 如果参数seconds 为0, 则之前设置的闹钟会被取消, 并将剩下的时间返回。

返回值：返回之前闹钟的剩余秒数, 如果之前未设闹钟则返回0。

可以设置忽略或者不捕获此信号，如果采用默认方式其动作是终止调用该alarm函数的进程。

### 管道通信

为了协调双方的通信，管道机制必须提供以下三方面的协调能力：

（1）互斥，即当一个进程正在对pipe执行读/写操作时，其它(另一)进程必须等待。

（2）同步，指当写(输入)进程把一定数量(如4KB)的数据写入pipe，便去睡眠等待，直到读(输出)进程取走数据后，再把他唤醒。当读进程读一空pipe时，也应睡眠等待，直至写进程将数据写入管道后，才将之唤醒。

（3）确定对方是否存在，只有确定了对方已存在时，才能进行通信。

管道是进程间通信的一种简单易用的方法。管道分为匿名管道和命名管道两种。匿名管道只能用于父子进程之间的通信，它的创建使用系统调用pipe()：

`int pipe(int fd[2]);`

其中的参数fd用于描述管道的两端，其中fd[0]是读端，fd[1]是写端。两个进程分别使用读端和写端，就可以进行通信了。

## 流程图

### 软中断通信

![image-20220318234302832](https://gitee.com/bright_xu/blog-image/raw/master/img/image-20220318234302832.png)
